@startuml
autonumber
autoactivate on
hide footbox

actor Guest
boundary "register.jsp" as JSP
control "RegisterController#doPost" as CTRL
entity "CustomerDAO" as DAO
entity "Customer" as DTO
control "DBContext" as DBC
database "Database" as DB

Guest -> JSP : 1. Click submit
JSP -> CTRL : 2. POST /register (name, phone, email, password, confirm, address, dob, gender)

opt [invalid data]
  CTRL --> JSP : 2.1 Display validation error
end

CTRL -> DAO : 3. existsByEmail(email)
DAO -> DB : 4. SELECT email
DB --> DAO : 5. true/false
DAO --> CTRL : 6. true/false

alt [email existed]
  CTRL --> JSP : 7. Forward register.jsp with error Email already exists
else [email not existed]
  CTRL -> DAO : 8. existsByPhone(phone)
  DAO -> DB : 9. SELECT phone
  DB --> DAO : 10. true/false
  DAO --> CTRL : 11. true/false

  alt [phone existed]
    CTRL --> JSP : 12. Forward register.jsp with error Phone already exists
  else [phone not existed]
    CTRL -> CTRL : 13. hash = MD5(password)
    CTRL -> DTO : 14. init Customer status ACTIVE
    DTO --> CTRL : 15. return Customer
    CTRL -> DAO : 16. insert(Customer)
    DAO -> DBC : 17. open connection
    DBC -> DB : 18. INSERT Customer
    DB --> DBC : 19. insert result
    DBC --> DAO : 20. result
    DAO --> CTRL : 21. result

    alt [insert success]
      CTRL --> JSP : 22. Redirect login.jsp
    else [insert fail]
      CTRL --> JSP : 23. Forward register.jsp with error
    end
  end
end
@enduml
