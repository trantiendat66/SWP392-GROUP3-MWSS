@startuml
autonumber
autoactivate on
hide footbox

actor Customer
boundary "cart.jsp" as JSP
control "OrderCreateFromCartServlet#doPost" as CTRL
entity "CartDAO" as CDAO
entity "ProductDAO" as PDAO
entity "OrderDAO" as ODAO
entity "Order" as O
entity "OrderDetail" as OD
control "DBContext" as DBC
database "Database" as DB

Customer -> JSP : 1. Click Place Order
JSP -> CTRL : 2. POST /order/create

CTRL -> CDAO : 3. getItemsByCustomer(customerId)
CDAO -> DBC : 3.1 open connection
DBC -> DB : 3.2 SELECT cart items
DB --> DBC : 3.3 items
DBC --> CDAO : 3.4 items
CDAO --> CTRL : 3.5 items

loop 4. For each cart item
  CTRL -> PDAO : 4.1 checkStock(productId, qty)
  PDAO -> DBC : 4.1.1 open connection
  DBC -> DB : 4.1.2 SELECT stock >= qty
  DB --> DBC : 4.1.3 true/false
  DBC --> PDAO : 4.1.4 true/false
  PDAO --> CTRL : 4.1.5 true/false
end

alt [any out of stock]
  CTRL --> JSP : 5. Show error "Some items are out of stock"
else [all in stock]
  loop 6. Get unit prices
    CTRL -> PDAO : 6.1 getUnitPrice(productId)
    PDAO -> DBC : 6.1.1 open connection
    DBC -> DB : 6.1.2 SELECT price
    DB --> DBC : 6.1.3 unit_price
    DBC --> PDAO : 6.1.4 unit_price
    PDAO --> CTRL : 6.1.5 unit_price
  end

  CTRL -> O : 7. Build Order(total_amount, status='Pending', payment_method=NULL)
  O --> CTRL : 7.1 Order
  CTRL -> ODAO : 8. createOrder(order, details)  ' transaction start inside DAO

  ODAO -> DBC : 8.1 open connection (begin transaction)
  DBC -> DB : 8.2 INSERT [Order]
  DB --> DBC : 8.3 new order_id
  DBC --> ODAO : 8.4 new order_id

  loop 9. Insert details & decrease stock
    ODAO -> DB : 9.1 INSERT OrderDetail(order_id, product_id, qty, unit_price)
    DB --> ODAO : 9.2 result
    ODAO -> DB : 9.3 UPDATE Product SET stock = stock - qty WHERE product_id = ?
    DB --> ODAO : 9.4 result
  end

  ODAO -> DBC : 10. commit
  DBC --> ODAO : 10.1 committed
  ODAO --> CTRL : 10.2 order_id

  CTRL -> CDAO : 11. clearCart(customerId)
  CDAO -> DBC : 11.1 open connection
  DBC -> DB : 11.2 DELETE FROM CartItem WHERE customer_id=?
  DB --> DBC : 11.3 result
  DBC --> CDAO : 11.4 result
  CDAO --> CTRL : 11.5 result

  CTRL --> JSP : 12. Redirect to payment selection (UC-12-02)
end
@enduml
