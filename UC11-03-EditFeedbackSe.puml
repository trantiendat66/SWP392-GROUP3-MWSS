@startuml
autonumber
autoactivate on
hide footbox

actor Customer
boundary "feedback-form.jsp" as JSP
control "FeedbackEditServlet#doPost" as EDIT
control "FeedbackDeleteServlet#doPost" as DEL
entity "FeedbackDAO" as FDAO
entity "Feedback" as DTO
control "DBContext" as DBC
database "Database" as DB

Customer -> JSP : 1. Submit action (Edit or Delete)

alt Edit
  JSP -> EDIT : 2. POST /feedback/edit (feedbackId, content, image?)
  opt [Invalid data]
    EDIT --> JSP : 2.1 Show validation error
  end

  EDIT -> FDAO : 3. existsByIdAndOwner(feedbackId, customerId)
  FDAO -> DBC : 3.1 open connection
  DBC -> DB : 3.2 SELECT 1 WHERE id=? AND customer_id=?
  DB --> DBC : 3.3 true/false
  DBC --> FDAO : 3.4 true/false
  FDAO --> EDIT : 3.5 true/false

  alt [Not owner or Not found]
    EDIT --> JSP : 4. Show error "Not allowed"
  else [Owner valid]
    EDIT -> FDAO : 5. findById(feedbackId)
    FDAO -> DBC : 5.1 open connection
    DBC -> DB : 5.2 SELECT Feedback by id
    DB --> DBC : 5.3 Feedback
    DBC --> FDAO : 5.4 Feedback
    FDAO --> EDIT : 5.5 Feedback

    EDIT -> EDIT : 6. Apply changes and set status=Pending
    EDIT -> FDAO : 7. update(feedback)
    FDAO -> DBC : 7.1 open connection
    DBC -> DB : 7.2 UPDATE Feedback
    DB --> DBC : 7.3 result
    DBC --> FDAO : 7.4 result
    FDAO --> EDIT : 7.5 result

    alt [Update success]
      EDIT --> JSP : 8. Show success
    else [Update fail]
      EDIT --> JSP : 9. Show error
    end
  end
else Delete
  JSP -> DEL : 2'. POST /feedback/delete (feedbackId)
  DEL -> FDAO : 3'. softDelete(feedbackId, customerId)
  FDAO -> DBC : 3'.1 open connection
  DBC -> DB : 3'.2 UPDATE Feedback SET status='Deleted' WHERE id=? AND customer_id=?
  DB --> DBC : 3'.3 result
  DBC --> FDAO : 3'.4 result
  FDAO --> DEL : 3'.5 result

  alt [Delete success]
    DEL --> JSP : 4'. Show success
  else [Delete fail]
    DEL --> JSP : 5'. Show error
  end
end
@enduml
