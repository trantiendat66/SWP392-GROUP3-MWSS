@startuml
autonumber
autoactivate on
hide footbox

actor Customer
boundary "product-detail.jsp" as JSP
control "RatingUpdateServlet#doPost" as CTRL
entity "OrderDAO" as ODAO
entity "RatingDAO" as RDAO
entity "Rating" as DTO
control "DBContext" as DBC
database "Database" as DB

Customer -> JSP : 1. Click Update Rating
JSP -> CTRL : 2. POST /rating/update (productId, stars, comment)

opt [Invalid data]
  CTRL --> JSP : 2.1 Show validation error
end

CTRL -> ODAO : 3. hasPurchased(customerId, productId)
ODAO -> DBC : 3.1 open connection
DBC -> DB : 3.2 SELECT purchase check
DB --> DBC : 3.3 true/false
DBC --> ODAO : 3.4 true/false
ODAO --> CTRL : 3.5 true/false

alt [not purchased]
  CTRL --> JSP : 4. Show error "Purchase required"
else [purchased]
  CTRL -> RDAO : 5. existsByCustomerAndProduct(customerId, productId)
  RDAO -> DBC : 5.1 open connection
  DBC -> DB : 5.2 SELECT rating exists
  DB --> DBC : 5.3 true/false
  DBC --> RDAO : 5.4 true/false
  RDAO --> CTRL : 5.5 true/false

  alt [rating NOT found]
    CTRL --> JSP : 6. Show error "No existing rating to update"
  else [rating found]
    CTRL -> RDAO : 7. getByCustomerAndProduct(customerId, productId)
    RDAO -> DBC : 7.1 open connection
    DBC -> DB : 7.2 SELECT current rating
    DB --> DBC : 7.3 Rating
    DBC --> RDAO : 7.4 Rating
    RDAO --> CTRL : 7.5 Rating

    CTRL -> DTO : 8. Build new Rating(stars, comment)
    DTO  --> CTRL : 8.1 Rating
    CTRL -> RDAO : 9. update(rating)
    RDAO -> DBC : 9.1 open connection
    DBC -> DB : 9.2 UPDATE Rating SET stars=?, comment=?, created_at=GETDATE() WHERE customer_id=? AND product_id=?
    DB  --> DBC : 9.3 result
    DBC --> RDAO : 9.4 result
    RDAO --> CTRL : 9.5 result

    alt [success]
      CTRL --> JSP : 10. Redirect to product detail with success
    else [fail]
      CTRL --> JSP : 11. Show error "Update failed"
    end
  end
end
@enduml
